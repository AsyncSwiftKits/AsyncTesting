name: CI

on:
  push:
    branches: 
      - "main"
    paths:
      - 'Sources/**'
      - 'Tests/**'
      - '.github/workflows/**'
      - 'Package.swift'
  pull_request:
    branches: 
      - "main"
    paths:
      - 'Sources/**'
      - 'Tests/**'
      - '.github/workflows/**'
      - 'Package.swift'

concurrency: 
  group: ${{ github.ref }}
  cancel-in-progress: true
jobs:
  build:
    name: ${{ matrix.command }} on ï£¿ ${{ matrix.platform }} (xcode ${{ matrix.xcode }}, ${{ matrix.macos }})
    runs-on: ${{ matrix.macos }} #os switching
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        xcode: ['13.4.1']
        macos: ['macos-11', 'macos-12']
        scheme: ['AsyncTesting']
        command: ['test']
        platform: ['macOS', 'iOS', 'tvOS', 'watchOS', 'mac-catalyst']
    steps:
    - uses: maxim-lobanov/setup-xcode@v1.4.1
      with:
        xcode-version: ${{ matrix.xcode }}
    - uses: mxcl/xcodebuild@v1.11.0
      with:
        platform: ${{ matrix.platform }}
        scheme: ${{ matrix.scheme }}
        action: ${{ matrix.command }} 
        code-coverage: true
        verbosity: xcpretty
        upload-logs: always
